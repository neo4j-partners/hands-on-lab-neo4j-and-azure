{
  "cells": [
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# --- Jupyter Notebook Cells ---\n",
        "\n",
        "# Cell 0: Install Dependencies\n",
        "\"\"\"\n",
        "# First, let's install the necessary Python packages.  Run this cell to install the 'openai', 'neo4j', and 'azure-storage-blob' libraries.\\n",
        "# These libraries allow us to work with OpenAI, Neo4j, and Azure Blob Storage, respectively.\\n",
        "# In a Jupyter Notebook, you can install packages using pip with a cell like this:\\n",
        "# !pip install openai neo4j azure-storage-blob\\n",
        "#\\n",
        "# Note: You only need to run this cell once.  If you are running this code in a non-notebook\\n",
        "#       environment, you'll need to install these packages using your system's terminal\\n",
        "#       (e.g.,  pip install openai neo4j azure-storage-blob).\\n",
        "\"\"\""
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# Cell 1: Import Libraries\n",
        "\"\"\"\n",
        "# Next, we'll import the Python libraries that we'll use in this notebook.\\n",
        "# These libraries provide functions for working with XML data, connecting to Neo4j, handling JSON, \\n",
        "# accessing Azure Blob Storage, and interacting with the OpenAI API.\\n",
        "\"\"\"\n",
        "import os\n",
        "from xml.etree import ElementTree as ET\n",
        "from neo4j import GraphDatabase\n",
        "import json\n",
        "from azure.storage.blob import BlobServiceClient\n",
        "import openai\n",
        "from openai import AzureOpenAI"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# Cell 2: Azure Blob Storage Setup\n",
        "\"\"\"\n",
        "# Now, we'll set up the connection to Azure Blob Storage.  You'll need to provide your Azure Blob Storage account URL.\\n",
        "# We'll use this to access the Form 13F data files.\\n",
        "# Replace with your actual Azure Blob Storage account URL\\n",
        "\"\"\"\n",
        "account_url = \"https://neo4jdataset.blob.core.windows.net/\"  \n",
        "container_name = \"form13-raw\"\n",
        "blob_service_client = BlobServiceClient(account_url=account_url)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# Cell 3: OpenAI Setup\n",
        "\"\"\"\n",
        "# Here, we configure the connection to Azure OpenAI.  You'll need to provide your Azure OpenAI credentials, including the endpoint, API version, API key, and deployment name.\\n",
        "# Replace with your actual Azure OpenAI credentials and deployment name\\n",
        "\"\"\"\n",
        "API_ENDPOINT = \"https://oneblinkopenaigenericservice.openai.azure.com/\"\n",
        "API_VERSION = \"2024-02-01\"\n",
        "API_KEY = \"8191daa13e01408887fcd362364937bb\"\n",
        "deployment_name = \"oneblink-gp4ouseast\"\n",
        "\n",
        "openai.api_type = \"azure\"\n",
        "openai.api_base = API_ENDPOINT\n",
        "openai.api_version = API_VERSION\n",
        "openai.api_key = API_KEY\n",
        "\n",
        "client = AzureOpenAI(\n",
        "    api_key=API_KEY,\n",
        "    api_version=API_VERSION,\n",
        "    azure_endpoint=API_ENDPOINT\n",
        ")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# Cell 4: Neo4j Setup\n",
        "\"\"\"\n",
        "# Now, let's set up the connection to the Neo4j graph database.  You'll need to provide your Neo4j connection URI, username, and password.\\n",
        "# Replace with your actual Neo4j connection URI, username, and password\\n",
        "\"\"\"\n",
        "NEO4J_URI = 'neo4j+s://neo4j-partners.com:443'\n",
        "NEO4J_USERNAME = 'neo4j'\n",
        "NEO4J_PASSWORD = 'FabricNeo@2024'\n",
        "driver = GraphDatabase.driver(NEO4J_URI, auth=(NEO4J_USERNAME, NEO4J_PASSWORD))"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# Cell 5: Helper Functions\n",
        "\"\"\"\n",
        "# We'll define a few helper functions to make the code more organized and reusable.\\n",
        "# These functions will handle reading XML data from Azure Blob Storage, extracting entities using OpenAI, and creating nodes in Neo4j.\\n",
        "\"\"\"\n",
        "def read_xml_from_azure(filename):\n",
        "    \"\"\"\n",
        "    Downloads and reads an XML file from Azure Blob Storage.\n",
        "    \"\"\"\n",
        "    try:\n",
        "        blob_client = blob_service_client.get_blob_client(container=container_name, blob=filename)\n",
        "        content = blob_client.download_blob(max_concurrency=1, encoding='UTF-8').readall()\n",
        "        \n",
        "        # Find the actual XML content\n",
        "        xml_start = content.find(b'<?xml version=\"1.0\"')\n",
        "        xml_end = content.find(b'</XML>')\n",
        "        \n",
        "        if xml_start != -1 and xml_end != -1:\n",
        "            xml_content = content[xml_start:xml_end + 6].decode('utf-8')  # Decode the relevant part\n",
        "            return xml_content\n",
        "        else:\n",
        "            print(f\"Could not find XML content in {filename}\")\n",
        "            return None\n",
        "            \n",
        "    except Exception as e:\n",
        "        print(f\"Error reading file {filename}: {e}\")\n",
        "        return None\n",
        "\n",
        "def extract_entities(xml_content):\n",
        "    \"\"\"\n",
        "    Extracts entities from the XML content using Azure OpenAI.\n",
        "    \"\"\"\n",
        "    if not xml_conten
